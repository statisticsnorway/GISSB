# crs_out = 4326,
turn_restrictions = TRUE)
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2021
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = TRUE)
# devtools::install_github("statisticsnorway/GISSB", auth_token = getPass::getPass("PAT: "))
#########################
### Turn restrictions ###
#########################
start.time <- Sys.time()
aargang <- 2021
# OBS: FROMNODEID/FROMNODE (lag dynamisk variabel?)
# OBS: TURNRESTRICTIONS (lag argument?)
crs_out <- 4326
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
# Laster inn vegnettet #
layers <- sf::st_layers("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb")
layers$name
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
# sf::st_transform(crs = 4326)   %>%
# sf::st_cast("LINESTRING") %>%
# dplyr::filter((Edge1FID == 1264892 | Edge2FCID == 1264892) |
#                 (Edge1FID == 639359 | Edge2FCID == 639360) |
#                 (Edge1FID == 1267023 | Edge2FCID == 466377)) %>%
data.frame()
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2021
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = TRUE)
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2021
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = TRUE)
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_FT_MINUTES <- vegnett_list[[4]]
graph_cppRouting_METERS <- vegnett_list[[5]]
# Bogstadveien eksempel
# Fra-til
# from_node_original <-  632345
# to_node_original <-  632449
# Til-fra
from_node_original <- 632449
to_node_original <-  632345
### Sannergata
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
# Bogstadveien eksempel
# Fra-til
from_node_original <-  632345
to_node_original <-  632449
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
from_node_original <-  632345
to_node_original <-  632449
## Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
Til-fra
from_node_original <- 632449
to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2021
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset() %>%
dplyr::rename(FT_MINUTES = DRIVETIME_FW,
TF_MINUTES = DRIVETIME_BW) %>%
dplyr::filter(ONEWAY == "TF" & TF_MINUTES > 0 |
ONEWAY == "FT" & FT_MINUTES > 0 |
ONEWAY == "B" & FT_MINUTES > 0 |
ONEWAY == "B" & TF_MINUTES > 0)
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
}
if (aargang <= 2021) {
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
}
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = TRUE)
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_FT_MINUTES <- vegnett_list[[4]]
graph_cppRouting_METERS <- vegnett_list[[5]]
### Bogstadveien eksempel 2021
# Fra-til
# from_node_original <-  632345
# to_node_original <-  632449
# Til-fra
from_node_original <- 632449
to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2022
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset() %>%
dplyr::rename(FT_MINUTES = DRIVETIME_FW,
TF_MINUTES = DRIVETIME_BW) %>%
dplyr::filter(ONEWAY == "TF" & TF_MINUTES > 0 |
ONEWAY == "FT" & FT_MINUTES > 0 |
ONEWAY == "B" & FT_MINUTES > 0 |
ONEWAY == "B" & TF_MINUTES > 0)
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
}
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2022
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset() %>%
dplyr::rename_all(toupper) %>%
dplyr::rename(FT_MINUTES = DRIVETIME_FW,
TF_MINUTES = DRIVETIME_BW) %>%
dplyr::filter(ONEWAY == "TF" & TF_MINUTES > 0 |
ONEWAY == "FT" & FT_MINUTES > 0 |
ONEWAY == "B" & FT_MINUTES > 0 |
ONEWAY == "B" & TF_MINUTES > 0)
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
}
if (aargang <= 2021) {
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
}
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = TRUE)
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_FT_MINUTES <- vegnett_list[[4]]
graph_cppRouting_METERS <- vegnett_list[[5]]
### Bogstadveien eksempel 2021
# Fra-til
# from_node_original <-  632345
# to_node_original <-  632449
# Til-fra
from_node_original <- 632449
to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
from_node_original <- 1450893
to_node_original <- 1473826
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
from_node_original <- 1473826
to_node_original <- 1450893
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2022
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset() %>%
dplyr::rename_all(toupper) %>%
dplyr::rename(FT_MINUTES = DRIVETIME_FW,
TF_MINUTES = DRIVETIME_BW) %>%
dplyr::filter(ONEWAY == "TF" & TF_MINUTES > 0 |
ONEWAY == "FT" & FT_MINUTES > 0 |
ONEWAY == "B" & FT_MINUTES > 0 |
ONEWAY == "B" & TF_MINUTES > 0)
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
}
if (aargang <= 2021) {
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
}
vegnett_list <- vegnett_to_R(vegnett = vegnett,
# crs_out = 4326,
turn_restrictions = FALSE)
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_FT_MINUTES <- vegnett_list[[4]]
graph_cppRouting_METERS <- vegnett_list[[5]]
### Bogstadveien eksempel 2021
## Fra-til
# from_node_original <-  632345
# to_node_original <-  632449
## Til-fra
# from_node_original <- 632449
# to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
### Bogstadveien eksempel 2022
from_node_original <- 1473826
to_node_original <- 1450893
# from_node_original <- 1450893
# to_node_original <- 1473826
from_node <- edges %>%
dplyr::filter(FROMNODEID == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID, from)
to_node <- edges %>%
dplyr::filter(TONODEID == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID, to)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
dplyr::mutate(long = unlist(map(nodes$geometry,1)),
lat = unlist(map(nodes$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from),
unique(to_node$to))) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
