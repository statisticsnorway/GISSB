library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2022
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
fromnodeID = "FROMNODEID",
tonodeID = "TONODEID",
FT_minutes = "FT_MINUTES",
TF_minutes = "TF_MINUTES",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826")) # OBS: muligens feil?
vegnett_list <- vegnett_to_R(vegnett = vegnett,
FT_minutes = "DRIVETIME_FW",
TF_minutes = "DRIVETIME_BW",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_minutes <- vegnett_list[[4]]
graph_cppRouting_meters <- vegnett_list[[5]]
if (aargang == 2021) {
### Bogstadveien eksempel 2021
## Fra-til
from_node_original <-  632345
to_node_original <-  632449
## Til-fra
# from_node_original <- 632449
# to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
}
if (aargang == 2022) {
### Bogstadveien eksempel 2022
from_node_original <- 1473826
to_node_original <- 1450893
# from_node_original <- 1450893
# to_node_original <- 1473826
}
from_node <- edges %>%
dplyr::filter(FROMNODEID_new == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID_new, from, direction)
to_node <- edges %>%
dplyr::filter(TONODEID_new == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID_new, to, direction)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "FT_MINUTES", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "meters", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "meter", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
GISSB::path_leaflet(path)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "DRIVETIME_FW", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2022
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
fromnodeID = "FROMNODEID",
tonodeID = "TONODEID",
FT_minutes = "FT_MINUTES",
TF_minutes = "TF_MINUTES",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826")) # OBS: muligens feil?
vegnett_list <- vegnett_to_R(vegnett = vegnett,
FT_minutes = "DRIVETIME_FW",
TF_minutes = "DRIVETIME_BW",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_minutes <- vegnett_list[[4]]
graph_cppRouting_meters <- vegnett_list[[5]]
if (aargang == 2021) {
### Bogstadveien eksempel 2021
## Fra-til
from_node_original <-  632345
to_node_original <-  632449
## Til-fra
# from_node_original <- 632449
# to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
}
if (aargang == 2022) {
### Bogstadveien eksempel 2022
from_node_original <- 1473826
to_node_original <- 1450893
# from_node_original <- 1450893
# to_node_original <- 1473826
}
from_node <- edges %>%
dplyr::filter(FROMNODEID_new == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID_new, from, direction)
to_node <- edges %>%
dplyr::filter(TONODEID_new == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID_new, to, direction)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "DRIVETIME_FW", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "meters", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
GISSB::path_leaflet(path)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "minutes", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
GISSB::path_leaflet(path)
from_node_original <- 1450893
to_node_original <- 1473826
from_node <- edges %>%
dplyr::filter(FROMNODEID_new == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID_new, from, direction)
to_node <- edges %>%
dplyr::filter(TONODEID_new == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID_new, to, direction)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "minutes", # OBS: må endres fra FT_MINUTES til DRIVETIME_FW for 2022?
path = TRUE)
GISSB::path_leaflet(path)
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
source("C:/Users/rdn/Documents/Github/GISSB/experimental/vegnett_to_R (TR).R", encoding = "UTF-8")
aargang <- 2021
# Laster inn vegnettet #
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
if (aargang <= 2021) {
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb", layer = "ERFKPS_turns") %>%
data.frame() %>%
dplyr::select(Edge1End, Edge1FID, Edge2FID)
vegnett_list <- vegnett_to_R(vegnett = vegnett,
fromnodeID = "FROMNODEID",
tonodeID = "TONODEID",
FT_minutes = "FT_MINUTES",
TF_minutes = "TF_MINUTES",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
if (aargang == 2022){
vegnett <- ds %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset()
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826")) # OBS: muligens feil?
vegnett_list <- vegnett_to_R(vegnett = vegnett,
FT_minutes = "DRIVETIME_FW",
TF_minutes = "DRIVETIME_BW",
meters = "SHAPE_LENGTH",
year = aargang,
turn_restrictions = TRUE)
}
graph <- vegnett_list[[1]]
nodes <- vegnett_list[[2]]
edges <- vegnett_list[[3]]
graph_cppRouting_minutes <- vegnett_list[[4]]
graph_cppRouting_meters <- vegnett_list[[5]]
if (aargang == 2021) {
### Bogstadveien eksempel 2021
## Fra-til
from_node_original <-  632345
to_node_original <-  632449
## Til-fra
# from_node_original <- 632449
# to_node_original <-  632345
### Sannergata 2021
# from_node_original <- 634745
# to_node_original <- 2674120
# from_node_original <- 2674120
# to_node_original <- 634745
}
if (aargang == 2022) {
### Bogstadveien eksempel 2022
# from_node_original <- 1473826
# to_node_original <- 1450893
from_node_original <- 1450893
to_node_original <- 1473826
}
from_node <- edges %>%
dplyr::filter(FROMNODEID_new == from_node_original & direction %in% c("B_FT", "FT")) %>%
data.frame() %>%
dplyr::select(FROMNODEID_new, from, direction)
to_node <- edges %>%
dplyr::filter(TONODEID_new == to_node_original & direction %in% c("B_TF", "TF")) %>%
data.frame() %>%
dplyr::select(TONODEID_new, to, direction)
path <- GISSB::shortest_path_igraph(from_node_ID = unique(from_node$from),
to_node_ID = unique(to_node$to),
unit = "minutes",
path = TRUE)
GISSB::path_leaflet(path)
###
node_points <- nodes %>%
sf::st_transform(crs = 4326)
node_points <-node_points %>%
dplyr::mutate(long = unlist(map(node_points$geometry,1)),
lat = unlist(map(node_points$geometry,2)))
test_points <- node_points %>%
dplyr::filter(nodeID %in% c(unique(from_node$from), unique(to_node$to))) %>%
# dplyr::filter(nodeID == 54507) %>%
leaflet::leaflet() %>%
leaflet::addTiles() %>%
leaflet::addMarkers(~long, ~lat, popup = ~as.character(paste(nodeID, ": ", lat, ", ", long)))
# test_points
# devtools::install_github("statisticsnorway/GISSB", auth_token = getPass::getPass("PAT: "))
#########################
### Turn restrictions ###
#########################
start.time <- Sys.time()
aargang <- 2021
# OBS: FROMNODEID/FROMNODE (lag dynamisk variabel?)
# OBS: TURNRESTRICTIONS (lag argument?)
crs_out <- 4326
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
# Laster inn vegnettet #
layers <- sf::st_layers("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20210401.gdb")
layers$name
#################
### Vegnettet ###
#################
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
vegnett <- ds %>%
dplyr::filter(FYLKE_ID %in% c("3")) %>%
sfarrow::read_sf_dataset()
suppressWarnings(
vegnett <- vegnett %>%
sf::st_zm(drop = T) %>%
dplyr::rename_all(toupper) %>%
sf::st_cast("LINESTRING") %>%
dplyr::filter(ONEWAY == "TF" & !!sym(TF_minutes) > 0 |
ONEWAY == "FT" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(TF_minutes) > 0)
)
suppressWarnings(
vegnett <- vegnett %>%
sf::st_zm(drop = T) %>%
dplyr::rename_all(toupper) %>%
sf::st_cast("LINESTRING") %>%
dplyr::filter(ONEWAY == "TF" & !!sym(TF_minutes) > 0 |
ONEWAY == "FT" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(TF_minutes) > 0)
)
vegnett_2 <- vegnett %>%
dplyr::mutate(km = !!sym(meters)/1000,
hours = !!sym(FT_minutes)/60,
km_h = km/hours,
FT_minutes_new = (km/ferry)*60,
!!FT_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(FT_minutes)
),
!!TF_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(TF_minutes)
)) %>%
dplyr::select(-km, -hours, -km_h, FT_minutes_new)
fromnodeID <- "FROMNODEID",
suppressWarnings(
vegnett <- vegnett %>%
sf::st_zm(drop = T) %>%
dplyr::rename_all(toupper) %>%
sf::st_cast("LINESTRING") %>%
dplyr::filter(ONEWAY == "TF" & !!sym(TF_minutes) > 0 |
ONEWAY == "FT" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(TF_minutes) > 0)
)
tonodeID <- "TONODEID"
fromnodeID <- "FROMNODEID"
tonodeID <- "TONODEID"
FT_minutes <- "FT_MINUTES"
TF_minutes <- "TF_MINUTES"
meters <- "SHAPE_LENGTH"
# Change km/h for ferry edges
if (is.numeric(ferry)==T){
vegnett_2 <- vegnett %>%
dplyr::mutate(km = !!sym(meters)/1000,
hours = !!sym(FT_minutes)/60,
km_h = km/hours,
FT_minutes_new = (km/ferry)*60,
!!FT_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(FT_minutes)
),
!!TF_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(TF_minutes)
)) %>%
dplyr::select(-km, -hours, -km_h, FT_minutes_new)
}
ferry <- 15
# Change km/h for ferry edges
if (is.numeric(ferry)==T){
vegnett_2 <- vegnett %>%
dplyr::mutate(km = !!sym(meters)/1000,
hours = !!sym(FT_minutes)/60,
km_h = km/hours,
FT_minutes_new = (km/ferry)*60,
!!FT_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(FT_minutes)
),
!!TF_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(TF_minutes)
)) %>%
dplyr::select(-km, -hours, -km_h, FT_minutes_new)
}
colnamemes(vegnett)
colnmaes(vegnett)
colnames(vegnett)
suppressWarnings(
vegnett <- vegnett %>%
sf::st_zm(drop = T) %>%
dplyr::rename_all(toupper) %>%
sf::st_cast("LINESTRING") %>%
dplyr::filter(ONEWAY == "TF" & !!sym(TF_minutes) > 0 |
ONEWAY == "FT" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(TF_minutes) > 0)
)
colnames(vegnett)
m
rename_geometry <- function(g, name){
current = attr(g, "sf_column")
names(g)[names(g)==current] = name
sf::st_geometry(g)=name
g
}
vegnett <- rename_geometry(vegnett, "geometry")
sf::st_geometry(vegnett) <- "geometry"
colnames(vegnett)
# Change km/h for ferry edges
if (is.numeric(ferry)==T){
vegnett_2 <- vegnett %>%
dplyr::mutate(km = !!sym(meters)/1000,
hours = !!sym(FT_minutes)/60,
km_h = km/hours,
FT_minutes_new = (km/ferry)*60,
!!FT_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(FT_minutes)
),
!!TF_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(TF_minutes)
)) %>%
dplyr::select(-km, -hours, -km_h, FT_minutes_new)
}
View(vegnett_2)
# devtools::install_github("statisticsnorway/GISSB", auth_token = getPass::getPass("PAT: "))
#########################
### Turn restrictions ###
#########################
start.time <- Sys.time()
aargang <- 2022
library(sf)
library(tidyverse)
library(sfarrow)
library(leaflet)
library(tidygraph)
library(cppRouting)
# Laster inn vegnettet #
sf::st_layers("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb")
turnrestrictions_geom <- sf::read_sf("C:/Users/rdn/Documents/Kart/Vegnett/vegnettRuteplan_FGDB_20220703.gdb", layer = "turnrestrictions_geom")
turnrestrictions_geom <- turnrestrictions_geom %>%
dplyr::filter(!(fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
# dplyr::filter((fromFromNode == "1473826" & fromToNode == "1499638" & toToNode == "1450893") |
#                 (fromFromNode == "1450893" & fromToNode == "1499638" & toToNode == "1473826"))
vegnett_parquet_filsti <- paste0("C:/Users/rdn/Documents/Kart/Vegnett/vegnett", aargang, ".parquet")
ds <- arrow::open_dataset(vegnett_parquet_filsti)
vegnett <- ds %>%
# dplyr::filter(fromnode %in% c("1473826", "1499638", "1450893") |
#               tonode %in% c("1473826", "1499638", "1450893")) %>%
dplyr::filter(municipality == "301") %>%
sfarrow::read_sf_dataset()
# fromnodeID <- "FROMNODEID"
# tonodeID <- "TONODEID"
# FT_minutes <- "FT_MINUTES"
# TF_minutes <- "TF_MINUTES"
# meters <- "SHAPE_LENGTH"
fromnodeID <- "FROMNODE"
tonodeID <- "TONODE"
FT_minutes <- "DRIVETIME_FW"
TF_minutes <- "DRIVETIME_BW"
meters <- "SHAPE_LENGTH"
ferry <- 15
suppressWarnings(
vegnett <- vegnett %>%
sf::st_zm(drop = T) %>%
dplyr::rename_all(toupper) %>%
sf::st_cast("LINESTRING") %>%
dplyr::filter(ONEWAY == "TF" & !!sym(TF_minutes) > 0 |
ONEWAY == "FT" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(FT_minutes) > 0 |
ONEWAY == "B" & !!sym(TF_minutes) > 0)
)
rename_geometry <- function(g, name){
current = attr(g, "sf_column")
names(g)[names(g)==current] = name
sf::st_geometry(g)=name
g
}
vegnett <- rename_geometry(vegnett, "geometry")
sf::st_geometry(vegnett) <- "geometry"
colnames(vegnett)
# Change km/h for ferry edges
if (is.numeric(ferry)==T){
vegnett_2 <- vegnett %>%
dplyr::mutate(km = !!sym(meters)/1000,
hours = !!sym(FT_minutes)/60,
km_h = km/hours,
FT_minutes_new = (km/ferry)*60,
!!FT_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(FT_minutes)
),
!!TF_minutes := case_when(
ROADCLASS == 4 ~ FT_minutes_new,
TRUE ~ !!sym(TF_minutes)
)) %>%
dplyr::select(-km, -hours, -km_h, FT_minutes_new)
}
